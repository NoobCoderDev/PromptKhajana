{% extends "base.html" %}

{% block title %}Reset Password - Prompt Khajana{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div class="text-center">
            <i class="fas fa-lock text-6xl text-indigo-600 dark:text-indigo-400 mb-4"></i>
            <h2 class="text-3xl font-bold gradient-text">Set New Password</h2>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Create a strong password for your account</p>
        </div>

        <div class="card rounded-xl shadow-lg p-8">
            <form method="POST" action="{{ url_for('auth.reset_password') }}" class="space-y-6" id="resetForm"
                novalidate>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        New Password
                    </label>
                    <input type="password" id="password" name="password" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                    <div id="password-error" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>

                <div>
                    <label for="confirm_password"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Confirm New Password
                    </label>
                    <input type="password" id="confirm_password" name="confirm_password" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                    <div id="confirm_password-error" class="text-red-500 text-sm mt-1 hidden"></div>
                </div>

                <div class="p-4 bg-gray-50 dark:bg-slate-700 rounded-lg">
                    <p class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Password Requirements:</p>
                    <ul class="text-xs text-gray-600 dark:text-gray-400 space-y-1" id="password-requirements">
                        <li id="req-length"><i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>At
                            least 8 characters long</li>
                        <li id="req-uppercase"><i class="fas fa-circle text-gray-400 mr-2"
                                style="font-size: 6px;"></i>One uppercase letter</li>
                        <li id="req-lowercase"><i class="fas fa-circle text-gray-400 mr-2"
                                style="font-size: 6px;"></i>One lowercase letter</li>
                        <li id="req-number"><i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>One
                            number</li>
                        <li id="req-special"><i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>One
                            special character (!@#$%^&*)</li>
                    </ul>
                </div>

                <button type="submit"
                    class="w-full btn-primary text-white font-semibold py-3 px-4 rounded-lg transition">
                    <i class="fas fa-save mr-2"></i> Reset Password
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('resetForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');

    function showError(fieldId, message) {
        const errorDiv = document.getElementById(fieldId + '-error');
        const inputField = document.getElementById(fieldId);
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        inputField.classList.add('border-red-500');
        inputField.classList.remove('border-gray-300', 'dark:border-slate-600');
    }

    function clearError(fieldId) {
        const errorDiv = document.getElementById(fieldId + '-error');
        const inputField = document.getElementById(fieldId);
        errorDiv.textContent = '';
        errorDiv.classList.add('hidden');
        inputField.classList.remove('border-red-500');
        inputField.classList.add('border-gray-300', 'dark:border-slate-600');
    }

    function clearAllErrors() {
        ['password', 'confirm_password'].forEach(clearError);
    }

    function validatePassword(password) {
        const errors = [];

        if (password.length < 8) {
            errors.push('at least 8 characters');
        }
        if (!/[A-Z]/.test(password)) {
            errors.push('one uppercase letter');
        }
        if (!/[a-z]/.test(password)) {
            errors.push('one lowercase letter');
        }
        if (!/\d/.test(password)) {
            errors.push('one number');
        }
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            errors.push('one special character');
        }

        if (errors.length > 0) {
            return { valid: false, message: 'Password must contain ' + errors.join(', ') };
        }
        return { valid: true };
    }

    function updatePasswordRequirements() {
        const password = passwordInput.value;

        const requirements = {
            'req-length': password.length >= 8,
            'req-uppercase': /[A-Z]/.test(password),
            'req-lowercase': /[a-z]/.test(password),
            'req-number': /\d/.test(password),
            'req-special': /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        for (const [id, met] of Object.entries(requirements)) {
            const element = document.getElementById(id);
            const icon = element.querySelector('i');
            if (met) {
                icon.classList.remove('fa-circle', 'text-gray-400');
                icon.classList.add('fa-check-circle', 'text-green-500');
                element.classList.add('text-green-600', 'dark:text-green-400');
            } else {
                icon.classList.remove('fa-check-circle', 'text-green-500');
                icon.classList.add('fa-circle', 'text-gray-400');
                element.classList.remove('text-green-600', 'dark:text-green-400');
            }
        }
    }

    passwordInput.addEventListener('input', updatePasswordRequirements);

    passwordInput.addEventListener('blur', function () {
        const password = this.value;
        if (password) {
            const result = validatePassword(password);
            if (!result.valid) {
                showError('password', result.message);
            } else {
                clearError('password');
            }
        }
    });

    confirmPasswordInput.addEventListener('blur', function () {
        const password = passwordInput.value;
        const confirmPassword = this.value;
        if (confirmPassword && password !== confirmPassword) {
            showError('confirm_password', 'Passwords do not match');
        } else if (confirmPassword) {
            clearError('confirm_password');
        }
    });

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        clearAllErrors();

        let isValid = true;

        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!password) {
            showError('password', 'Password is required');
            isValid = false;
        } else {
            const passwordResult = validatePassword(password);
            if (!passwordResult.valid) {
                showError('password', passwordResult.message);
                isValid = false;
            }
        }

        if (!confirmPassword) {
            showError('confirm_password', 'Please confirm your password');
            isValid = false;
        } else if (password !== confirmPassword) {
            showError('confirm_password', 'Passwords do not match');
            isValid = false;
        }

        if (isValid) {
            form.submit();
        }
    });
</script>
{% endblock %}